class Ajax{callController(parameter,callBackFunction){$.ajax({url:"../app/controller/ajax.php",type:"POST",data:parameter,dataType:"json",success:function(callBackData){eval(callBackFunction+"(callBackData)")},error:function(a,typeError,textError){let error0='{"errMessage": "Se ha producido un error en la conexion", "errCodeException": "", "errMessageException": "" }',error1='{"errMessage": "Se ha producido un error en la conexion", "errCodeException":"'+typeError+'", "errMessageException":"'+textError+'"}';eval(callBackFunction+'({"succes": false, "errores": ['+error0+","+error1+"]})")}})}}class Pedidos{getParameterSearchPedidosCliente(){return"action=searchPedidos&"+$("#formSearch").serialize()}getParameterSearchLineas(e){return"action=searchLineasPedidos&cod_pedido="+e+"&"+$("#formSearch").serialize()}getParameterUpdateLineas(){return"action=updateLineasPedidos&"+$("#formLineas").serialize()}getParameterProcesarLineas(){let e="action=procesarLineasPedidos&usuario="+$("#usuario").val()+"&cod_pedido="+$("#cod_pedido").val()+"&cod_gestor="+$("#cod_gestor").val()+"&cod_cliente="+$("#cod_cliente").val();for(let a=0;a<lineasPedidos.length;a++)"pendiente"===$("#estado-"+lineasPedidos[a].cod_linea).val()&&$("#estado-"+lineasPedidos[a].cod_linea).prop("checked")&&(e+="&cod_linea-"+lineasPedidos[a].cod_linea+"=pendiente",e+="&cod_articulo-"+lineasPedidos[a].cod_linea+"="+lineasPedidos[a].cod_articulo,e+="&cantidad-"+lineasPedidos[a].cod_linea+"="+lineasPedidos[a].cantidad);return e}getCodClientePedido(e){for(let a=0;a<pedidos.length;a++)if(pedidos[a].cod_pedido===e)return pedidos[a].cod_cliente}evalInputsCantidades(){let e=document.getElementsByClassName("cantidades"),a=[];a.success=!0,a.errores=[];for(let t=0;t<e.length;t++)validateCantidad(e[t].value)||(a.success=!1,a.errores.push(e[t].name.split("-")[0]+" - "+e[t].name.split("-")[1]));return a}getTextErrorCantidades(e){let a="<strong>Las siguientes lineas de pedidos tienen un formato de cantidades incorrectas</strong><br>";for(let t=0;t<e.length;t++)a+=e[t];return a}evalEstadoInputs(){let e=[];e.success=!1;for(let a=0;a<lineasPedidos.length;a++)"pendiente"===$("#estado-"+lineasPedidos[a].cod_linea).val()&&$("#estado-"+lineasPedidos[a].cod_linea).prop("checked")&&(e.success=!0);return e}evalExistPendientes(){let e=[];e.success=!1;for(let a=0;a<lineasPedidos.length;a++)"pendiente"===$("#estado-"+lineasPedidos[a].cod_linea).val()&&(e.success=!0);return e}formatDate(e){let a=e.split("-");return a[2]+"-"+a[1]+"-"+a[0]}}var pedidosApp=new Pedidos,ajaxApp=new Ajax,pedidos="",lineasPedidos="",cod_pedido="";function addEventsPedidos(){$("#search").click(search),$("#procesar").click(evalCantidades)}function addEventsSiguiente(){$("#siguiente").click(searchSiguiente)}function addEventsAnterior(){$("#anterior").click(searchAnterior)}function delEventsSig(){$("#siguiente").off()}function delEventsAnt(){$("#anterior").off()}function addEventsLineas(e){for(let a=0;a<e.length;a++)$("#cod_pedido-"+e[a].cod_pedido).off(),$("#cod_pedido-"+e[a].cod_pedido).click(searchLineas)}function addEventsButtonLineas(){$(document).off("click","#procesarLineas"),$(document).off("click","#buttonLineas"),$(document).off("click","#buttonVolver"),$(document).on("click","#procesarLineas",evalEstados),$(document).on("click","#buttonLineas",evalCantidades),$(document).on("click","#buttonVolver",restorePedidos)}function validateCantidad(e){return esNumeroPositivoEntero(e)||"0"===e}function searchLineas(e){cleanLineas(),cod_pedido=e.target.id.split("-")[1],ajaxApp.callController(pedidosApp.getParameterSearchLineas(cod_pedido),"callBackSearchLineas")}function callBackSearchLineas(e){e.success?(addEventsButtonLineas(),lineasPedidos=e.lineas_pedidos,injectLineas(e.lineas_pedidos,pedidosApp.getCodClientePedido(cod_pedido))):msjDanger("PEDIDOS",e.errores[0].errMessage)}function evalCantidades(){pedidosApp.evalInputsCantidades().success?pedidosApp.evalExistPendientes().success?ajaxApp.callController(pedidosApp.getParameterUpdateLineas(),"callBackEvalCantidades"):msjInfo("PEDIDOS","<strong>No se puede realizar la accion<br></strong>Todas las lineas han sido procesadas"):msjDanger("PEDIDOS",pedidosApp.getTextErrorCantidades(result.errores))}function callBackEvalCantidades(e){e.success?(msjSucces("PEDIDOS","<strong>Se ha actualizado correctamente su pedido</strong>"),restorePedidos(),cleanTbody()):msjDanger("PEDIDOS",e.errores[0].errMessage)}function evalEstados(){pedidosApp.evalExistPendientes().success?pedidosApp.evalEstadoInputs().success?ajaxApp.callController(pedidosApp.getParameterProcesarLineas(),"callBackEvalEstado"):msjInfo("PEDIDOS","<strong>No has modificado ningun estado</strong>"):msjInfo("PEDIDOS","<strong>No se puede realizar la accion<br></strong>Todas las lineas han sido procesadas")}function callBackEvalEstado(e){e.success?(msjSucces("PEDIDOS","<strong>Se ha procesado correctamente el pedido</strong>"),restorePedidos(),cleanTbody()):msjDanger("PEDIDOS",e.errores[0].errMessage)}function search(){cleanTbody(),restorePedidos(),delEventsSig(),delEventsAnt(),$("#numPage").val(1),injectPageNumber(),ajaxApp.callController(pedidosApp.getParameterSearchPedidosCliente(),"callBackSearchPedidosCliente")}function callBackSearchPedidosCliente(e){e.success?0!==e.pedidos.length&&(pedidos=e.pedidos,injectPedidos(e.pedidos),addEventsLineas(e.pedidos),addEventsSiguiente()):msjDanger("PEDIDOS",e.errores[0].errMessage)}function searchSiguiente(){restorePedidos(),delEventsSig(),delEventsAnt(),$("#numPage").val(1*$("#numPage").val()+1),ajaxApp.callController(pedidosApp.getParameterSearchPedidosCliente(),"callBackSearchSiguiente")}function callBackSearchSiguiente(e){e.success?(0!==e.pedidos.length?(cleanTbody(),pedidos=e.pedidos,injectPedidos(e.pedidos),addEventsLineas(e.pedidos),addEventsSiguiente()):$("#numPage").val(1*$("#numPage").val()-1),"1"!==$("#numPage").val()&&addEventsAnterior(),injectPageNumber()):msjDanger("PEDIDOS",e.errores[0].errMessage)}function searchAnterior(){restorePedidos(),delEventsSig(),delEventsAnt(),$("#numPage").val(1*$("#numPage").val()-1),ajaxApp.callController(pedidosApp.getParameterSearchPedidosCliente(),"callBackSearchAnterior")}function callBackSearchAnterior(e){e.success?(cleanTbody(),pedidos=e.pedidos,injectPedidos(e.pedidos),addEventsLineas(e.pedidos),addEventsSiguiente(),"1"!==$("#numPage").val()&&addEventsAnterior(),injectPageNumber()):msjDanger("PEDIDOS",e.errores[0].errMessage)}function esTexto(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esLetra(e[t])||(a=!1,t=e.length);else a=!1;return a}function esTextoNumero(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esLetra(e[t])||esNumeros(e[t])||(a=!1,t=e.length);else a=!1;return a}function esTextoEspacio(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esLetra(e[t])||esEspacio(e[t])||(a=!1,t=e.length);else a=!1;return a}function esNumeroMas(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esNumero(e[t])||esMas(e[t])||(a=!1,t=e.length);else a=!1;return a}function esNumeroGuion(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esNumero(e[t])||esGuion(e[t])||(a=!1,t=e.length);else a=!1;return a}function esNumeros(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esNumero(e[t])||(a=!1,t=e.length);else a=!1;return a}function esTextoEspacioPuntoComaBarraNumero(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esTexto(e[t])||esEspacio(e[t])||esPunto(e[t])||esComa(e[t])||esNumero(e[t])||esBarra(e[t])||(a=!1,t=e.length);else a=!1;return a}function esTextoPunto(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esTexto(e[t])||esPunto(e[t])||(a=!1,t=e.length);else a=!1;return a}function esTextoBarra(e){let a=!0;if(""!==e&&null!==e)for(let t=0;t<e.length;t++)esTexto(e[t])||esPunto(e[t])||(a=!1,t=e.length);else a=!1;return a}function esNumeroPositivoEntero(e){return parseInt(e)&&esPositivo(e)&&esEntero(e)}function esLetra(e){return e.charCodeAt()>64&&e.charCodeAt()<91||165===e.charCodeAt()||164===e.charCodeAt()||e.charCodeAt()>96&&e.charCodeAt()<123}function esEspacio(e){return 32===e.charCodeAt()}function esNumero(e){return e.charCodeAt()>47&&e.charCodeAt()<58}function esPositivo(e){return parseInt(e)>0}function esEntero(e){return parseInt(e)%1==0}function esGuion(e){return 45===e.charCodeAt()}function esPunto(e){return 46===e.charCodeAt()}function esComa(e){return 44===e.charCodeAt()}function esContBarra(e){return 47===e.charCodeAt()}function esBarra(e){return 92===e.charCodeAt()}function esMas(e){return 43===e.charCodeAt()}function msjDanger(e,a){let t=Math.floor(1e16*Math.random()+1);$("#mensajes").append('<div class="modal fade bd-example-modal-lg" id="danger'+t+'" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header modal-header-danger"><h1>'+e+'</h1></div><div class="modal-body">'+a+'</div><div class="modal-footer"><button type="button" class="btn btn-default pull-rigth" data-dismiss="modal">Cerrar</button></div></div></div></div>'),$("#danger"+t).modal("show")}function msjWarning(e,a){let t=Math.floor(1e16*Math.random()+1);$("#mensajes").append('<div class="modal fade bd-example-modal-lg" id="warning'+t+'" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header modal-header-warning"><h1>'+e+'</h1></div><div class="modal-body">'+a+'</div><div class="modal-footer"><button type="button" class="btn btn-default pull-rigth" data-dismiss="modal">Cerrar</button></div></div></div></div>'),$("#warning"+t).modal("show")}function msjSucces(e,a){let t=Math.floor(1e16*Math.random()+1);$("#mensajes").append('<div class="modal fade bd-example-modal-lg" id="success'+t+'" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header modal-header-success"><h1>'+e+'</h1></div><div class="modal-body">'+a+'</div><div class="modal-footer"><button type="button" class="btn btn-default pull-rigth" data-dismiss="modal">Cerrar</button></div></div></div></div>'),$("#success"+t).modal("show")}function msjInfo(e,a){let t=Math.floor(1e16*Math.random()+1);$("#mensajes").append('<div class="modal fade bd-example-modal-lg" id="info'+t+'" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header modal-header-info"><h1>'+e+'</h1></div><div class="modal-body">'+a+'</div><div class="modal-footer"><button type="button" class="btn btn-default pull-rigth" data-dismiss="modal">Cerrar</button></div></div></div></div>'),$("#info"+t).modal("show")}function cleanTbody(){$("#tbody").empty()}function restorePedidos(){$("#tableLineas").empty(),$("#tablePedidos").attr("hidden",!1)}function cleanLineas(){$("#tableLineas").empty()}function injectPedidos(e){for(let a=0;a<e.length;a++)$("#tbody").append("<tr><td>"+e[a].cod_pedido+"</td><td>"+e[a].cod_cliente+" - "+e[a].nombre_cliente+"</td><td>"+pedidosApp.formatDate(e[a].fecha)+"</td><td>"+e[a].estado+'</td><td><input type="button" id="cod_pedido-'+e[a].cod_pedido+'" value="'+e[a].lineas+'" class="form-control btn-primary"></td></tr>')}function injectPageNumber(){$("#pageActual").empty(),$("#pageActual").append($("#numPage").val())}function injectLineas(e,a){let t='<form id="formLineas" name="formLineas"><h2>Pedido '+e[0].cod_pedido+'</h2><input type="hidden" id="usuario" name="usuario" value="gestor"><input type="hidden" name="cod_gestor" value="'+$("#cod_gestor").val()+'"><input type="hidden" id="cod_pedido" name="cod_pedido" value="'+e[0].cod_pedido+'"><input type="hidden" id="cod_cliente" name="cod_cliente" value="'+a+'"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Linea</th><th>Articulo</th><th>Precio</th><th>Iva</th><th>Total</th><th>Estado</th><th>Cantidad</th></tr></thead><tbody>';for(let a=0;a<e.length;a++)t+="<tr><td>"+e[a].cod_linea+"</td><td>"+e[a].cod_articulo+" - "+e[a].nombre_articulo+"</td><td>"+e[a].precio.replace(".",",")+"</td><td>"+e[a].iva.replace(".",",")+"</td><td>"+e[a].total.replace(".",",")+"</td>","pendiente"===e[a].estado?(t+='<td><div class="material-switch"><input id="estado-'+e[a].cod_linea+'" name="estado-'+e[a].cod_linea+'" type="checkbox" value="pendiente"/><label for="estado-'+e[a].cod_linea+'" class="label-warning"></label></div></td>',t+='<td><input type="number" name="cod_linea-'+e[a].cod_linea+'" value="'+e[a].cantidad+'" class="cantidades form-control" min="0" step="1"></td></tr>'):(t+='<td><div class="material-switch"><input id="estado-'+e[a].cod_linea+'" name="estado-'+e[a].cod_linea+'" type="checkbox" value="procesador" checked disabled/><label for="estado-'+e[a].cod_linea+'" class="label-warning"></label></div></td>',t+='<td><input type="number" name="cod_linea-'+e[a].cod_linea+'" value="'+e[a].cantidad+'" class="cantidades form-control" min="0" step="1" disabled></td></tr>');t+='<tr><td></td><td></td><td></td><td></td><td></td><td></td><td><input type="button" id="procesarLineas" name="procesarLineas" class="form-control btn-warning" value="Procesar"></td><td></td></tr>',t+='<tr><td></td><td></td><td></td><td></td><td></td><td></td><td><input type="button" id="buttonLineas" name="buttonLineas" class="form-control btn-warning" value="Actualizar"></td><td></td></tr>',t+='<tr><td></td><td></td><td></td><td></td><td></td><td></td><td><input type="button" id="buttonVolver" name="buttonVolver" class="form-control btn-primary" value="Volver"></td><td></td></tr>',t+="</tbody></table></div></form>",$("#tablePedidos").attr("hidden",!0),$("#tableLineas").append(t)}document.onload=addEventsPedidos();